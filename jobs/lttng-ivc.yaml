- defaults: &lttng-ivc-defaults
    name: lttng-ivc
    description: |
      LTTng Inter Version Compatibility test suite.

      <p>Job is managed by Jenkins Job Builder.</p>

    project-type: freestyle

    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor:
          colormap: xterm

    scm:
      - git:
          url: https://github.com/{github_user}/{github_name}.git
          browser: githubweb
          browser-url: https://github.com/{github_user}/{github_name}
          branches:
            - origin/{version}
          basedir: src
          skip-tag: true

    triggers:
      - timed: "@daily"

    parameters:
      - string: &lttng-ivc-parameter-pytest_filter
          name: 'pytest_filter'
          default: '{pytest_filter}'
          description: 'Enter an optional filter for the pytest tests to execute'

    properties:
      - build-discarder:
          num-to-keep: 10
          artifact-num-to-keep: 2
      - github:
          url: https://github.com/{github_user}/{github_name}

    # job variables
    email_to: ''
    github_user: lttng
    github_name: lttng-ivc
    job_suffix: ''
    pytest_filter: ''

- defaults:
    <<: *lttng-ivc-defaults
    name: lttng-ivc-review
    concurrent: true
    parameters:
      - string:
          <<: *lttng-ivc-parameter-pytest_filter
      - string:
          name: 'GERRIT_BRANCH'
          default: 'master'
      - string:
          name: 'GERRIT_REFSPEC'
          default: ''
          description: 'The refspec to fetch. E.g. `refs/changes/15/14715/2`. You may find it in the gerrit interface for downloading a specific revision of patch'
      - string:
          name: 'GERRIT_NAME'
          default: 'review.lttng.org'
      - string:
          name: 'GERRIT_HOST'
          default: 'review.lttng.org'
      - string:
          name: 'GERRIT_PATCHSET_REVISION'
          default: ''
      - string:
          name: 'GERRIT_PROJECT'
          default: 'lttng-ivc'
    scm:
      - git: &lttng-tools_scm_git_review
          url: https://review.lttng.org/lttng-ivc
          refspec: 'refs/changes/*:refs/changes/*'
          branches:
            - '$GERRIT_REFSPEC'
          basedir: src
          skip-tag: true
    triggers: !j2-yaml: |
      {% if enable_gerrit_trigger %}
      - gerrit:
          {% if gerrit_approval_values %}
          trigger-on:
            {% for value in gerrit_approval_values %}
            - comment-added-event:
                approval-category: 'CI-Build'
                approval-value: '{{ value }}'
            {% endfor %}
          {% endif %}
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'lttng-ivc'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: '{version}'
      {% else %}[]{% endif %}

    # Job variables
    email_to: 'ci-notification@lists.lttng.org'
    enable_gerrit_trigger: true
    gerrit_approval_values: !!python/tuple [1]

## Templates
- job-template: &lttng-ivc-version-template
    name: 'lttng-ivc-{version}{job_suffix}'
    defaults: lttng-ivc

    project-type: matrix
    node: 'master' # Applies only to matrix flyweight task
    axes:
      - axis:
         type: slave
         name: platform
         values: '{obj:platforms}'

    builders:
      - shell:
         !include-raw-verbatim: scripts/lttng-ivc/build.sh

    publishers:
      - archive:
          artifacts: 'artifacts/**'
          follow-symlinks: true
          allow-empty: false
      - junit:
          results: result.xml
      - workspace-cleanup
      - email-ext:
          recipients: '{obj:email_to}'
          reply-to: ci-notification@lists.lttng.org
          always: false
          unstable: false
          first-failure: true
          first-unstable: true
          not-built: false
          aborted: false
          regression: false
          failure: false
          second-failure: false
          improvement: false
          still-failing: false
          success: false
          fixed: false
          fixed-unhealthy: true
          still-unstable: false
          pre-build: false
          matrix-trigger: only-parent
          send-to:
            - recipients

- job-template:
    <<: *lttng-ivc-version-template
    name: 'dev_review_lttng-ivc-{version}{job_suffix}'
    defaults: lttng-ivc-review

- job-template: &lttng-ivc-version-modules-template
    name: 'lttng-ivc-{version}-modules{job_suffix}'
    defaults: lttng-ivc

    project-type: matrix
    node: 'master' # Applies only to matrix flyweight task
    axes:
      - axis:
         type: slave
         name: slave
         values: '{obj:slave}'
      - axis:
         type: user-defined
         name: platform
         values: '{obj:platforms}'

    builders:
      - shell:
         !include-raw-verbatim: scripts/lttng-ivc/build.sh

    publishers:
      - archive:
          artifacts: 'artifacts/**'
          follow-symlinks: true
          allow-empty: false
      - junit:
          results: result.xml
      - workspace-cleanup
      - email-ext:
          recipients: '{obj:email_to}'
          reply-to: ci-notification@lists.lttng.org
          always: false
          unstable: false
          first-failure: true
          first-unstable: true
          not-built: false
          aborted: false
          regression: false
          failure: false
          second-failure: false
          improvement: false
          still-failing: false
          success: false
          fixed: false
          fixed-unhealthy: true
          still-unstable: false
          pre-build: false
          matrix-trigger: only-parent
          send-to:
            - recipients

- job-template:
    <<: *lttng-ivc-version-modules-template
    name: 'dev_review_lttng-ivc-{version}-modules{job_suffix}'
    defaults: lttng-ivc-review

## Project
- project:
    name: lttng-ivc
    platforms: !!python/tuple [deb13-amd64]
    slave: !!python/tuple [deb13-amd64-rootnode]
    version:
      - master
    jobs:
      # Run all tests
      - 'lttng-ivc-{version}-modules{job_suffix}': &job-lttng-ivc-master-tools-master
          job_suffix: '_lttng-tools-master'
      - 'dev_review_lttng-ivc-{version}-modules{job_suffix}':
          <<: *job-lttng-ivc-master-tools-master
      # Only stable-2.14
      - 'lttng-ivc-{version}-modules{job_suffix}': &job-lttng-ivc-master-tools-stable-2-14
          job_suffix: '_lttng-tools-stable-2.14'
          pytest_filter: '2.14 and not master'
      - 'dev_review_lttng-ivc-{version}-modules{job_suffix}':
          <<: *job-lttng-ivc-master-tools-stable-2-14
          enable_gerrit_trigger: false
      # Only stable-2.13
      - 'lttng-ivc-{version}-modules{job_suffix}': &job-lttng-ivc-master-tools-stable-2-13
          job_suffix: '_lttng-tools-stable-2.13'
          pytest_filter: '2.13 and not master'
      - 'dev_review_lttng-ivc-{version}-modules{job_suffix}':
          <<: *job-lttng-ivc-master-tools-stable-2-13
          enable_gerrit_trigger: false
