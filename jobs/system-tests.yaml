---
## Anchors
- _system_tests_parameters_defaults: &system_tests_parameters_defaults
    name: 'system_tests_parameters_defaults'
    parameters:
      - string:
          name: 'LTTNG_TOOLS_COMMIT_ID'
          default: ''
          description: 'The lttng-tools commit id to build.'
      - string:
          name: 'LTTNG_MODULES_COMMIT_ID'
          default: ''
          description: 'The lttng-modules commit id to build.'
      - string:
          name: 'LTTNG_UST_COMMIT_ID'
          default: ''
          description: 'The lttng-ust commit id to build.'
      - string:
          name: 'KERNEL_COMMIT_ID'
          default: ''
          description: 'The linux kernel commit id to build against.'
      - string:
          name: 'KERNEL_REPO'
          default: 'git://git-mirror.internal.efficios.com/kernel/stable/linux-stable.git'
          description: 'Linux kernel git repo to checkout the kernel id'
      - string:
          name: 'LTTNG_TOOLS_REPO'
          default: 'git://git-mirror.internal.efficios.com/lttng/lttng-tools.git'
          description: 'LTTng-Tools git repo to checkout the tools id'
      - string:
          name: 'LTTNG_MODULES_REPO'
          default: 'git://git-mirror.internal.efficios.com/lttng/lttng-modules.git'
          description: 'LTTng-Modules git repo to checkout the Modules id'
      - string:
          name: 'LTTNG_UST_REPO'
          default: 'git://git-mirror.internal.efficios.com/lttng/lttng-ust.git'
          description: 'LTTng-UST git repo to checkout the UST id'
      - string:
          name: 'ROOTFS_URL'
          default: 'https://obj-lava.internal.efficios.com/rootfs/rootfs_amd64_trixie_2025-09-25.tar.xz'
          description: 'The URL at which the system root FS can be downloaded'
      - string:
          name: 'LTTNG_CI_REPO'
          default: 'https://github.com/lttng/lttng-ci.git'
          description: 'LTTng-ci git repo to checkout the CI scripts'
      - string:
          name: 'LTTNG_CI_BRANCH'
          default: 'master'
          description: 'The branch of the CI repository to clone for job scripts'
      - string:
          name: 'LAVA_USERNAME'
          default: 'lava-jenkins'
          description: 'The username to authenticate with the LAVA instance'
      - string:
          name: 'LAVA_HOST'
          default: 'lava-master-03.internal.efficios.com'
          description: 'The hostname of the LAVA instance'
      - choice:
          name: 'LAVA_PROTO'
          choices:
            - 'http'
            - 'https'
          description: 'The protocol to use with the LAVA host'
      - string:
          name: 'S3_HOST'
          description: 'Host for the s3 object storage'
          default: 'obj2.internal.efficios.com'
      - string:
          name: 'S3_BUCKET'
          description: 'Bucket for the s3 object storage'
          default: 'lava'
      - string:
          name: 'S3_BASE_DIR'
          description: 'Base directory for the s3 object storage'
          default: 'system-tests'
      - string:
          name: 'S3_HTTP_BUCKET_URL'
          description: 'Base url to access the s3 bucket over unauthenticated HTTP'
          default: 'https://obj-lava.internal.efficios.com'

- publisher:
    name: 'system_tests_email_ext_default'
    publishers:
      - email-ext:
          recipients: 'ci-notification@lists.lttng.org'
          reply-to: ci-notification@lists.lttng.org
          always: false
          unstable: false
          first-failure: true
          first-unstable: true
          not-built: false
          aborted: false
          regression: false
          failure: false
          second-failure: false
          improvement: false
          still-failing: false
          success: false
          fixed: false
          fixed-unhealthy: true
          still-unstable: false
          pre-build: false
          matrix-trigger: only-parent
          send-to:
            - recipients

- job-template:
    name: vm_tests_k{kversion}_l{lttngversion}
    description: |
      Runs root_regression and root_destructive_tests on a virtual machine over different combinations of kernel and lttng configurations.
    project-type: freestyle
    node: 'deb13-amd64'
    <<: *system_tests_parameters_defaults

    properties:
      - build-discarder:
          num-to-keep: 10
      - throttle:
          max-total: 4
          option: 'category'
          categories:
            - 'kvm-tests'

    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava2_key
              variable: LAVA2_JENKINS_TOKEN
          - username-password-separated:
              credential-id: s3_obj_lava_key
              username: S3_ACCESS_KEY
              password: S3_SECRET_KEY
      - inject:
          properties-content: |
            BUILD_DEVICE=kvm
            LTTNG_VERSION={lttngversion}

    scm:
      - git:
          url: "${{LTTNG_CI_REPO}}"
          basedir: src/lttng-ci/
          branches:
            - "${{LTTNG_CI_BRANCH}}"

    builders:
      - trigger-builds:
        - project: "build_kernel_PARAM"
          block: true
          predefined-parameters: |
            BUILD_DEVICE=kvm
            LTTNG_MODULES_COMMIT_ID=${{LTTNG_MODULES_COMMIT_ID}}
            LTTNG_MODULES_REPO=${{LTTNG_MODULES_REPO}}
            KERNEL_COMMIT_ID=${{KERNEL_COMMIT_ID}}
            KERNEL_REPO=${{KERNEL_REPO}}
            BUILD_DEVICE=kvm
            LTTNG_CI_REPO=${{LTTNG_CI_REPO}}
            LTTNG_CI_BRANCH=${{LTTNG_CI_BRANCH}}
            S3_HOST=${{S3_HOST}}
            S3_BUCKET=${{S3_BUCKET}}
            S3_BASE_DIR=${{S3_BASE_DIR}}
            S3_HTTP_BUCKET_URL=${{S3_HTTP_BUCKET_URL}}
      - shell: !include-raw-verbatim: scripts/system-tests/run-lava-tests.sh

    publishers:
      - workspace-cleanup
      - email-ext:
          recipients: '{obj:email_to}'
          always: false
          unstable: false
          first-failure: true
          first-unstable: true
          not-built: false
          aborted: false
          regression: false
          failure: false
          second-failure: false
          improvement: false
          still-failing: true
          success: false
          fixed: false
          fixed-unhealthy: true
          still-unstable: false
          pre-build: false
          matrix-trigger: only-parent
          send-to:
            - recipients

- job-template:
    name: baremetal_tests_k{kversion}_l{lttngversion}
    description: |
      Runs perf_regression tests on a baremetal machine over different combinations of kernel and lttng configurations.
    project-type: freestyle
    node: 'deb13-amd64'

    <<: *system_tests_parameters_defaults

    properties:
      - build-discarder:
          num-to-keep: 10
          artifact-num-to-keep: 2
      - throttle:
          max-total: 2
          option: 'category'
          categories:
            - 'baremetal-tests'

    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - text:
              credential-id: jenkins_lava2_key
              variable: LAVA2_JENKINS_TOKEN
          - username-password-separated:
              credential-id: s3_obj_lava_key
              username: S3_ACCESS_KEY
              password: S3_SECRET_KEY
      - inject:
          properties-content: |
            BUILD_DEVICE=baremetal
            LTTNG_VERSION={lttngversion}

    scm:
      - git:
          url: "${{LTTNG_CI_REPO}}"
          basedir: src/lttng-ci/
          branches:
            - "${{LTTNG_CI_BRANCH}}"

    builders:
      - trigger-builds:
        - project: "build_kernel_PARAM"
          block: true
          predefined-parameters: |
            BUILD_DEVICE=baremetal
            LTTNG_MODULES_COMMIT_ID=${{LTTNG_MODULES_COMMIT_ID}}
            LTTNG_MODULES_REPO=${{LTTNG_MODULES_REPO}}
            KERNEL_COMMIT_ID=${{KERNEL_COMMIT_ID}}
            KERNEL_REPO=${{KERNEL_REPO}}
            BUILD_DEVICE=baremetal
            LTTNG_CI_REPO=${{LTTNG_CI_REPO}}
            LTTNG_CI_BRANCH=${{LTTNG_CI_BRANCH}}
            S3_HOST=${{S3_HOST}}
            S3_BUCKET=${{S3_BUCKET}}
            S3_BASE_DIR=${{S3_BASE_DIR}}
            S3_HTTP_BUCKET_URL=${{S3_HTTP_BUCKET_URL}}
      - shell: !include-raw-verbatim: scripts/system-tests/run-lava-tests.sh

    publishers:
      - workspace-cleanup

- job-template:
    name: build_kernel_PARAM
    description: |
      Builds a Linux Kernel and LTTng Modules if necessary
    concurrent: true
    node: 'deb13-amd64'

    parameters:
      - string:
          name: 'LTTNG_MODULES_COMMIT_ID'
          description: 'The lttng-modules commmit to build.'
      - string:
          name: 'LTTNG_MODULES_REPO'
          description: 'The LTTng Modules git repo to fetch from'
          default: 'git://git-mirror.internal.efficios.com/lttng/lttng-modules.git'
      - string:
          name: 'KERNEL_COMMIT_ID'
          description: 'The kernel commit to build.'
      - string:
          name: 'KERNEL_REPO'
          description: 'The kernel git repo to fetch from'
      - string:
          name: 'BUILD_DEVICE'
          description: 'The target device. (kvm or baremetal)'
      - string:
          name: 'LTTNG_CI_REPO'
          default: 'https://github.com/lttng/lttng-ci.git'
          description: 'LTTng-ci git repo to checkout the CI scripts'
      - string:
          name: 'LTTNG_CI_BRANCH'
          default: 'master'
          description: 'The branch of the CI repository to clone for job scripts'
      - string:
          name: 'S3_HOST'
          description: 'Host for the s3 object storage'
      - string:
          name: 'S3_BUCKET'
          description: 'Bucket for the s3 object storage'
      - string:
          name: 'S3_BASE_DIR'
          description: 'Base directory for the s3 object storage'
      - string:
          name: 'S3_HTTP_BUCKET_URL'
          description: 'Base url to access the s3 bucket over unauthenticated HTTP'
          default: 'https://obj-lava.internal.efficios.com'

    properties:
      - build-discarder:
          days-to-keep: 2

    wrappers:
      - workspace-cleanup
      - timestamps
      - ansicolor
      - credentials-binding:
          - username-password-separated:
              credential-id: s3_obj_lava_key
              username: S3_ACCESS_KEY
              password: S3_SECRET_KEY

    scm:
      - git:
          url: "${{LTTNG_CI_REPO}}"
          basedir: src/lttng-ci/
          branches:
            - "${{LTTNG_CI_BRANCH}}"

    builders:
      - shell: !include-raw-verbatim: scripts/system-tests/build-kernel-param.sh

    publishers:
      - workspace-cleanup

- job-template:
    name: system_ALL_{test_type}_trigger
    description: |
      This job will trigger the build of jobs when a new tag is push specific
      tracked Linux branches and new commits on LTTng tracked branches

    project-type: freestyle
    node: 'master'
    parameters:
      - bool:
          name: 'FORCE_JOB_RUN'
          default: false
          description: 'Force the child jobs to run'
      - bool:
          name: 'FORCE_FAILED_JOB_RUN'
          default: true
          description: 'Force the failed child jobs to run'

    properties:
      - build-discarder:
          num-to-keep: 10

    triggers:
      - timed: "H 0 * * 1-5"

    wrappers:
      - timestamps
      - ansicolor

    builders:
      - system-groovy:
         command:
           !include-raw-verbatim: scripts/system-tests/system-trigger.groovy

    publishers:
      - system_tests_email_ext_default

## Project

# Canary jobs are made to confirm that the whole Lava pipeline is working.
# They are scheduled once a day always on the same (LTTng, Kernel) code. If any
# of those jobs fails, it means that there is an issue with the configuration

# Only build the "supported" version against the master kernel since
# "unsupported" version do not get backport for new kernel.
- project:
    name: system-tests-supported-kmaster
    email_to: 'ci-notification@lists.lttng.org, cc:jgalar@efficios.com'
    kversion:
      - master
    lttngversion:
      - master
      - stable-2.14
      - stable-2.13
    jobs:
      - 'vm_tests_k{kversion}_l{lttngversion}'
      - 'baremetal_tests_k{kversion}_l{lttngversion}'

## Views
- view-template:
    name: 'System tests'
    view-type: list
    regex: 'vm_tests_.*|baremetal_tests_.*|baremetal_benchmarks_.*|system_.*'

# Test against particular linux version.

# Test against upstream Linux supported LTS branches and the SLTS v4.4
- project:
    name: system-tests
    email_to: 'ci-notification@lists.lttng.org, cc:jgalar@efficios.com'
    kversion:
      - canary
      - linux-4.4.y
      - linux-5.10.y
      - linux-5.15.y
      - linux-6.1.y
      - linux-6.6.y
      - linux-6.12.y
    lttngversion:
      - canary
      - master
      - stable-2.14
      - stable-2.13
    jobs:
      - 'vm_tests_k{kversion}_l{lttngversion}'
      - 'baremetal_tests_k{kversion}_l{lttngversion}'

# Stable-2.12 doesn't support kernels over v5.18
- project:
    name: system-tests-2.12
    email_to: 'ci-notification@lists.lttng.org, cc:jgalar@efficios.com'
    kversion:
      - linux-4.4.y
      - linux-5.10.y
      - linux-5.15.y
    lttngversion:
      - stable-2.12
    jobs:
      - 'vm_tests_k{kversion}_l{lttngversion}'
      - 'baremetal_tests_k{kversion}_l{lttngversion}'

- project:
    name: system-general
    test_type:
      - vm_tests
      - baremetal_tests
    jobs:
      - 'build_kernel_PARAM'
      - 'system_ALL_{test_type}_trigger'

- project:
    name: system-tests-views
    views:
      - 'System tests'
